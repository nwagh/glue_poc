{"paragraphs":[{"text":"%pyspark\n## Perform Glue Imports\nimport sys\nfrom pyspark.context import SparkContext\nfrom awsglue.context import GlueContext\nfrom awsglue.transforms import *\nfrom awsglue.utils import getResolvedOptions\nfrom awsglue.dynamicframe import DynamicFrame\nfrom pyspark.sql.functions import *\n\nsc=sc if 'sc' in vars() else SparkContext()\nglueContext = GlueContext(sc)\nspark = glueContext.spark_session\n","user":"admin","dateUpdated":"2018-10-15T17:54:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1538430723336_784741191","id":"20181001-215203_1851572616","dateCreated":"2018-10-01T21:52:03+0000","dateStarted":"2018-10-15T17:54:50+0000","dateFinished":"2018-10-15T17:54:50+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:4924"},{"text":"%pyspark\n\n## Read Glue Catalogs into Dynamic Frames\ntranDyF = glueContext.create_dynamic_frame.from_catalog(database='banking',table_name='transactions')\nacctDyF = glueContext.create_dynamic_frame.from_catalog(database='banking',table_name='accounts')\ncustDyF = glueContext.create_dynamic_frame.from_catalog(database='banking',table_name='customers')","user":"admin","dateUpdated":"2018-10-15T17:55:00+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1538430735655_-1911378242","id":"20181001-215215_387996243","dateCreated":"2018-10-01T21:52:15+0000","dateStarted":"2018-10-10T23:39:54+0000","dateFinished":"2018-10-10T23:40:19+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4925"},{"text":"%pyspark\n\n## Print Schema\ntranDyF.printSchema()","user":"admin","dateUpdated":"2018-10-15T17:55:01+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n|-- tran_id: long\n|-- acct_id: long\n|-- tran_code: string\n|-- tran_date: timestamp\n|-- tran_amount: double\n|-- Year: int\n|-- Month: int\n\n"}]},"apps":[],"jobName":"paragraph_1538496819496_-814737794","id":"20181002-161339_792928878","dateCreated":"2018-10-02T16:13:39+0000","dateStarted":"2018-10-10T20:59:12+0000","dateFinished":"2018-10-10T20:59:12+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4926"},{"text":"%pyspark\n\n## Create Spark Temp View\ntranDyF.toDF().createTempView(\"tran_view\")","user":"admin","dateUpdated":"2018-10-15T17:55:01+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1538505987118_-2010561290","id":"20181002-184627_961694338","dateCreated":"2018-10-02T18:46:27+0000","dateStarted":"2018-10-10T23:40:25+0000","dateFinished":"2018-10-10T23:40:25+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4927"},{"text":"%pyspark\n\n## Execute Spark SQL using Temp View \ntranfilterdDF = spark.sql(\"SELECT acct_id,month\\\n    , CAST(sum((CASE tran_code WHEN \\'S\\' THEN tran_amount ELSE 0 END)) AS decimal(10,2)) as service_charges\\\n    , CAST(sum((CASE tran_code WHEN \\'D\\' THEN tran_amount ELSE 0 END)) AS decimal(10,2)) as debit_charges\\\n    , CAST(sum((CASE tran_code WHEN \\'C\\' THEN tran_amount ELSE 0 END)) AS decimal(10,2)) as credit_charges\\\n    , CAST(sum((CASE tran_code WHEN \\'L\\' THEN tran_amount ELSE 0 END)) AS decimal(10,2)) as late_fees\\\n    FROM\\\n    tran_view where year = \\'2017\\' and month=\\'4\\' \\\n    GROUP BY acct_id, month\")","user":"admin","dateUpdated":"2018-10-15T17:55:01+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1538503039617_884568329","id":"20181002-175719_1534050949","dateCreated":"2018-10-02T17:57:19+0000","dateStarted":"2018-10-10T23:40:58+0000","dateFinished":"2018-10-10T23:40:59+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4928"},{"text":"%pyspark\n\n## Print output\ntranfilterdDF.head(5)","user":"admin","dateUpdated":"2018-10-15T17:55:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"[Row(acct_id=32443334, month=4, service_charges=Decimal('0.00'), debit_charges=Decimal('40870.97'), credit_charges=Decimal('0.00'), late_fees=Decimal('0.00')), Row(acct_id=32451357, month=4, service_charges=Decimal('0.00'), debit_charges=Decimal('1319.81'), credit_charges=Decimal('0.00'), late_fees=Decimal('0.00')), Row(acct_id=32451460, month=4, service_charges=Decimal('0.00'), debit_charges=Decimal('0.00'), credit_charges=Decimal('0.00'), late_fees=Decimal('5819.93')), Row(acct_id=32452814, month=4, service_charges=Decimal('0.00'), debit_charges=Decimal('0.00'), credit_charges=Decimal('30877.62'), late_fees=Decimal('0.00')), Row(acct_id=32453052, month=4, service_charges=Decimal('0.00'), debit_charges=Decimal('0.00'), credit_charges=Decimal('34336.90'), late_fees=Decimal('0.00'))]\n"}]},"apps":[],"jobName":"paragraph_1538497268466_1410504825","id":"20181002-162108_543147403","dateCreated":"2018-10-02T16:21:08+0000","dateStarted":"2018-10-10T23:41:06+0000","dateFinished":"2018-10-10T23:46:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4929"},{"text":"%pyspark\n\n## Perfrom Join Operation on Dynamic Frames\ntranfilteredDyF = DynamicFrame.fromDF(tranfilterdDF,glueContext,name=\"tranfilteredDyF\")\nuc1JoinDyF = Join.apply(frame1= Join.apply(tranfilteredDyF,acctDyF,\"acct_id\",\"account_id\",transformation_ctx='join1')\\\n    ,frame2=custDyF,keys1=\"customer_id\",keys2=\"customer_id\", transformation_ctx=\"join2\" )\\\n    .select_fields([\"first_name\",\"last_name\",\"account_name\",\"month\",\"service_charges\",\"debit_charges\",\"credit_charges\",\"late_fees\"])","user":"admin","dateUpdated":"2018-10-15T17:55:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1538497323669_-1041222436","id":"20181002-162203_539791482","dateCreated":"2018-10-02T16:22:03+0000","dateStarted":"2018-10-10T23:47:15+0000","dateFinished":"2018-10-10T23:47:16+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4930"},{"text":"%pyspark\n\n## Print Result schema\nuc1JoinDyF.printSchema()","user":"admin","dateUpdated":"2018-10-15T17:55:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n|-- first_name: string\n|-- last_name: string\n|-- account_name: string\n|-- month: int\n|-- service_charges: decimal\n|-- debit_charges: decimal\n|-- credit_charges: decimal\n|-- late_fees: decimal\n\n"}]},"apps":[],"jobName":"paragraph_1539206037013_-1544636849","id":"20181010-211357_1163949614","dateCreated":"2018-10-10T21:13:57+0000","dateStarted":"2018-10-10T23:47:19+0000","dateFinished":"2018-10-10T23:58:13+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4931"},{"text":"%pyspark\n\n## Dynamic Frame to Dataframe\nuc1JoinDF = uc1JoinDyF.toDF()\n\n## Concatenate 2 columns\nuc1DF = uc1JoinDF.select(concat(uc1JoinDF['first_name'],lit(' '),uc1JoinDF['last_name']).alias('Customer Name'),\\\n                        \"account_name\", \"month\",\"service_charges\",\"debit_charges\",\"credit_charges\",\"late_fees\")\n                        \n## Coalesce reduces number of partitions                         \nuc1DF1 = uc1DF.coalesce(10)                        \n\n## Print output\nuc1DF1.head(5)","user":"admin","dateUpdated":"2018-10-15T17:55:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"[Row(Customer Name=u'Kevin Cruz', account_name=u'c5e5177d-81f7-008e-6226-29b721398c00', month=4, service_charges=Decimal('66809.86'), debit_charges=Decimal('0.00'), credit_charges=Decimal('0.00'), late_fees=Decimal('0.00')), Row(Customer Name=u'Jeffrey Rivera', account_name=u'7441dfb3-4714-f789-ad75-9d7907b2d0de', month=4, service_charges=Decimal('0.00'), debit_charges=Decimal('0.00'), credit_charges=Decimal('3792.58'), late_fees=Decimal('0.00')), Row(Customer Name=u'Brandon Boone', account_name=u'436e1090-393c-743a-e2da-c2a9f9115456', month=4, service_charges=Decimal('32773.15'), debit_charges=Decimal('0.00'), credit_charges=Decimal('0.00'), late_fees=Decimal('0.00')), Row(Customer Name=u'Edward Thomas', account_name=u'c336f32f-538a-ff4b-9bda-e900614b7364', month=4, service_charges=Decimal('17066.12'), debit_charges=Decimal('0.00'), credit_charges=Decimal('0.00'), late_fees=Decimal('0.00')), Row(Customer Name=u'Bruce Brown', account_name=u'df0d991f-251d-0508-2221-311dee3dec78', month=4, service_charges=Decimal('0.00'), debit_charges=Decimal('0.00'), credit_charges=Decimal('35509.06'), late_fees=Decimal('0.00'))]\n"}]},"apps":[],"jobName":"paragraph_1539216368426_846244621","id":"20181011-000608_122811511","dateCreated":"2018-10-11T00:06:08+0000","dateStarted":"2018-10-11T00:57:38+0000","dateFinished":"2018-10-11T00:57:46+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4932"},{"text":"%pyspark\n\n## Convert to Dynamic Frame\nuc1DyF = DynamicFrame.fromDF(uc1DF1,glueContext,\"uc1DyF\")\n\n## Rename Headers for output report\nuc1DyF = uc1DyF.rename_field(\"account_name\",\"Account Number\")\\\n    .rename_field(\"month\",\"Transaction Month\")\\\n    .rename_field(\"service_charges\",\"Sum of Service Charges\")\\\n    .rename_field(\"debit_charges\",\"Sum of Debit Charges\")\\\n    .rename_field(\"credit_charges\",\"Sum of Credit Charges\")\\\n    .rename_field(\"late_fees\",\"Sum Of Late_fees\")\n    \n","user":"admin","dateUpdated":"2018-10-15T17:55:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1539217751850_1051280726","id":"20181011-002911_590670663","dateCreated":"2018-10-11T00:29:11+0000","dateStarted":"2018-10-11T00:57:55+0000","dateFinished":"2018-10-11T00:57:55+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4933"},{"text":"%pyspark\n\n## Ensure Headers are correct\nuc1DyF.printSchema()","user":"admin","dateUpdated":"2018-10-15T17:55:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n|-- Customer Name: string\n|-- Account Number: string\n|-- Transaction Month: int\n|-- Sum of Service Charges: decimal\n|-- Sum of Debit Charges: decimal\n|-- Sum of Credit Charges: decimal\n|-- Sum Of Late_fees: decimal\n\n"}]},"apps":[],"jobName":"paragraph_1539218288865_2102981716","id":"20181011-003808_438721021","dateCreated":"2018-10-11T00:38:08+0000","dateStarted":"2018-10-11T00:40:14+0000","dateFinished":"2018-10-11T00:41:56+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4934"},{"text":"%pyspark\n## Write to S3 bucket\nglueContext.write_dynamic_frame.from_options(frame = uc1DyF, connection_type = \"s3\", connection_options={ \"path\": \"s3://<bucket>/report/\"}, format_options={\"separator\":\",\",\"withHeader\":True,\"writeHeader\":True}, format=\"csv\")","user":"admin","dateUpdated":"2018-10-15T17:55:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1538497413308_2015176854","id":"20181002-162333_1182592955","dateCreated":"2018-10-02T16:23:33+0000","dateStarted":"2018-10-11T00:58:07+0000","dateFinished":"2018-10-11T01:34:51+0000","status":"ERROR","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:4935"},{"text":"%pyspark\n","user":"admin","dateUpdated":"2018-10-02T19:21:00+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1538508060478_449479372","id":"20181002-192100_142245819","dateCreated":"2018-10-02T19:21:00+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:4936"}],"name":"UC1_Report","id":"2DRT3X7QC","angularObjects":{"2CRE5X63N:shared_process":[],"2CQZ9JC8F:shared_process":[],"2CNAPD13W:shared_process":[],"2CRC324G8:existing_process":[],"2CQ1X8PFU:shared_process":[],"2CNFC7TNE:shared_process":[],"2CMQ2EHTE:shared_process":[],"2CQUCJVJA:shared_process":[],"2CQY3SUDK:shared_process":[],"2CNA37GFQ:shared_process":[],"2CPH9H73W:shared_process":[],"2CR2XFEE3:shared_process":[],"2CQ9YVF7W:shared_process":[],"2CP1P36EU:shared_process":[],"2CMR9MKCE:shared_process":[],"2CR2YZBFW:shared_process":[],"2CPJK4U6W:shared_process":[],"2CR2Z9UR2:shared_process":[],"2CPQWHWM3:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}
